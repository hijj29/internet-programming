# Лабораторная работа №9: Расширенное управление контейнерами и оркестрация в Docker

## 1. Резервное копирование volume статического контента

Используем docker compose для создания контейнера с статическим контентом и его резервного копирования:

```yaml
 version: '3' services: static_content: image: nginx:latest volumes: - ./static_content:/usr/share/nginx/html ports: - "8080:80"
```
Создаем директорию для статического контента и скопируем в нее файлы:
```bash
 mkdir static_content && cd static_content wget https://example.com/example.html -O example.html
```
Запускаем docker compose и создаем резервную копию:

```bash
 docker-compose up -d docker-compose stop docker volume create backup_static_content docker-compose up -v backup_static_content:/usr/share/nginx/html
```
## 2. Установка сервера времени NTP

Создаем Dockerfile для Ubuntu и CentOS:

Ubuntu:
```Dockerfile
FROM ubuntu:20.04 RUN apt-get update && apt-get install -y ntp CMD ["ntpd"]
```
CentOS:
```Dockerfile
 FROM centos:7 RUN yum update -y && yum install -y ntp CMD ["ntpd"]
```
Создаем Dockerfile для Alpine Linux:
```Dockerfile
 FROM alpine:latest RUN apk add --no-cache ntpd CMD ["ntpd"]
```
Запускаем контейнеры:
```bash
 docker run -d --name ubuntu_ntp ubuntu_ntp docker run -d --name centos_ntp centos_ntp docker run -d --name alpine_ntp alpine_ntp
```
## 3. Создание образа для резервного копирования

Создаем Dockerfile для резервного копирования:
```Dockerfile
 FROM ubuntu:20.04 COPY backup_script.sh /backup_script.sh RUN chmod +x /backup_script.sh CMD ["/backup_script.sh"]
```
Создаем скрипт резервного копирования:
```bash
 #!/bin/bash docker volume create backup_volume docker exec static_content tar -czf backup.tar.gz /usr/share/nginx/html docker run --rm --volumes-from=backup_volume ubuntu_backup bash -c "cat backup.tar.gz | gzip > backup.tar.gz.gzip"
```
## 4. Резервное копирование и восстановление базы данных

Для PostgreSQL:
```sql CREATE TABLE users ( id SERIAL PRIMARY KEY, name VARCHAR(255) );

INSERT INTO users VALUES (1, 'John Doe');
```
Создаем Dockerfile для PostgreSQL:
```Dockerfile
 FROM postgres:13 COPY init.sql /docker-entrypoint-initdb.d/
```
Запускаем контейнер и выполняем резервное копирование:
```bash
 docker run -d --name pg_backup postgres_backup docker exec pg_backup pg_dumpall > dump.sql
```
Восстанавливаем базу данных:
```bash
 docker run --rm --volumes-from=pg_backup postgres_restore cat dump.sql | psql -U postgres
```
Для MongoDB:
```json \
{ "_id": ObjectId("..."), "name": "MongoDB Backup", "type": "database", "state": "connected", "storageEngine": "wiredTiger" }
```
Запускаем контейнер и выполняем резервное копирование:
```bash
 docker run -d --name mongo_backup mongo_backup docker exec mongo_backup mongodump --out /dump
```
Восстанавливаем базу данных:
```bash
 docker run --rm --volumes-from=mongo_backup mongo_restore mongorestore --db test /dump/test
```
## 5. Изучение инструментов Duplicity, Velero, Restic

### Duplicity

Duplicity - это инструмент для шифрованного резервного копирования. Основные особенности:
- Шифрование на стороне клиента
- Поддержка различных хранилищ (локальные файловые системы, облачные сервисы)
- Инкрементальное резервное копирование

Пример использования:
```bash
 duplicity /path/to/source s3://my-bucket/duplicity-backup
```
### Velero

Velero - это инструмент управления резервными копиями для Kubernetes. Основные возможности:
- Резервное копирование и восстановление кластеров Kubernetes
- Поддержка разных типов хранилищ
- Шифрование резервных копий

Пример установки:
```bash
 velero install --provider aws
--plugins velero/aws
--bucket my-cluster-backups
--use-with-cross-account-roles
--region us-west-2
```
### Restic

Restic - это легковесный инструмент для шифрованного резервного копирования. Особенности:
- Шифрование на стороне клиента
- Поддержка различных хранилищ
- Инкрементальное резервное копирование

Пример использования:
```bash
 restic backup /path/to/source s3:my-bucket
```

